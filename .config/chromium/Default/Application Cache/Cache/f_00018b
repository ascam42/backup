var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};define("odsp-next/dataSources/upload/BaseBatchUploader",["require","exports","odsp-shared/base/BaseModel","knockout"],function(e,t,r,i){var n=function(e){function t(t){e.call(this,t),this.filesUploading=i.observableArray(),this.batchStartTime=t.batchStartTime}return __extends(t,e),t.prototype.start=function(){throw new Error("Not Implemented")},t}(r);return n}),define("odsp-next/dataSources/upload/FileUploadType",["require","exports"],function(){var e=function(){function e(){}return e.Html5="h5",e.Silverlight="sl",e.Downlevel="dl",e}();return e}),define("odsp-next/dataSources/upload/odb/FileValidationStatus",["require","exports"],function(){var e;return function(e){e[e.invalid=-1]="invalid",e[e.pending=0]="pending",e[e.valid=1]="valid"}(e||(e={})),e}),define("odsp-next/dataSources/upload/odb/Html5FileUpload",["require","exports","../../../utilities/icons/IconSelector","../FileUploadType","./FileValidationStatus"],function(e,t,r,i,n){var a=function(){function e(e,t){this._disposed=!1;var a=this;a.file=e,a.name=e.fileName||e.name;var o=a.name.lastIndexOf(".");a.extension=o>=0?a.name.substring(o):"",a.iconName=r.getIconNameFromExtension(a.extension),a.size=e.size,a.eTag=e.eTag,a.downlevel=!1,a.canResizeOnClient=!1;var s=e.lastModifiedDate;if(a.lastModified="",s){var l=s.getUTCDate();l=10>l?"0"+l:l;var u=s.getUTCMonth()+1;u=10>u?"0"+u:u;var d=s.getUTCHours();d=10>d?"0"+d:d;var p=s.getUTCMinutes();p=10>p?"0"+p:p;var h=s.getUTCSeconds();h=10>h?"0"+h:h,a.lastModified=s.getUTCFullYear()+":"+u+":"+l+" "+d+":"+p+":"+h}a.upType=i.Html5,a.dragDrop=Boolean(t)?t:!1,a.isLocked=!1,a.validationStatus=n.pending,a.validationResult=""}return e.prototype.isFolder=function(e){var t=this;if(t.file.isFolder)e(!0);else{var r=new FileReader;r.onload=function(){t._disposed||e(r.result||t.extension?!1:!0)},r.onerror=function(){t._disposed||e(!0)};try{r.readAsArrayBuffer(t.getBlob(0,Math.min(1,t.file.size)))}catch(i){e(!0)}}},e.prototype.dispose=function(){this._disposed=!0,this.file=null},e.prototype.getBlob=function(e,t){var r=null;return this.file&&(this.file.slice?r=this.file.slice(e,t):this.file.mozSlice?r=this.file.mozSlice(e,t):this.file.webkitSlice&&(r=this.file.webkitSlice(e,t))),r},e}();return a}),define("odsp-next/utilities/queue/QueueTaskState",["require","exports"],function(){var e;return function(e){e[e.Disconnected=0]="Disconnected",e[e.Pending=1]="Pending",e[e.Active=2]="Active",e[e.Complete=3]="Complete"}(e||(e={})),e}),define("odsp-next/utilities/queue/Queue",["require","exports","./QueueTaskState","odsp-utilities/async/Async","odsp-utilities/async/Promise"],function(e,t,r,i,n){var a=function(){function e(t,r){this._pendingTaskCount=0,this._activeTaskCount=0,this._currentSetTimeoutId=0,this._async=new i(this),this._nextTaskId=0,this._tasks={},this._activeTasks={},this._isAbortingAll=!1,this._isProcessingTasks=!1,this._maxSimultaneousTasks=t||e.DEFAULT_SIMULTANEOUS_TASKS,this._queueId=r||e.DEFAULT_QUEUEID}return e.prototype.enqueuePromise=function(e){var t=this,r=String(this._nextTaskId++),i=function(i,n){t.enqueue(function(t){return e().then(function(e){t(),i(e)},function(e){t(),n(e)}),!0},null,r)},a=function(){t.abortTask(r)};return new n.default(i,a)},e.prototype.enqueue=function(e,t,i){var n=!1;if(!this._isAbortingAll){i=i||String(this._nextTaskId++);var a=this._tasks[i];(!a||a.state===r.Pending&&a.next)&&(a?this.detachTask(a):(n=!0,a=this._tasks[i]=this.createNewTask(e,t,i)),this.insertTask(a),this.ensureProcessingTasks())}return n},e.prototype.abortAll=function(){this._isAbortingAll=!0;for(var e in this._tasks)this.abortTask(e);this._isAbortingAll=!1},e.prototype.abortTask=function(e){var t=this._tasks[e];t&&(t.state===r.Active?(this.completeTask(t),Boolean(t.abort)&&t.abort()):this.detachTask(t),this.removeTaskFromQueue(t))},e.prototype.createNewTask=function(e,t,i){var n={id:i,exec:e,abort:t,timeoutId:0,next:null,prev:null,state:r.Disconnected};return n},e.prototype.detachTask=function(e){return e&&e.state===r.Pending&&(Boolean(e.prev)&&(e.prev.next=e.next),Boolean(e.next)&&(e.next.prev=e.prev),this._taskHead===e&&(this._taskHead=e.next),this._taskTail===e&&(this._taskTail=e.prev),e.state=r.Disconnected,e.prev=e.next=null,this._pendingTaskCount--),e},e.prototype.insertTask=function(e){if(Boolean(e)&&e.state===r.Disconnected){var t=this._taskTail;t?(t.next=e,e.prev=t):this._taskHead=e,this._taskTail=e,e.state=r.Pending,this._pendingTaskCount++}},e.prototype.ensureProcessingTasks=function(){function t(e){if(e){n._activeTaskCount++,n._activeTasks[e.id]=e,e.startTime=(new Date).getTime(),e.state=r.Active;var t=n,i=e.exec(function(){t.completeTask(e)});i||n.completeTask(e)}return e}function i(){for(n._currentSetTimeoutId=0,n._isProcessingTasks=!0;n._pendingTaskCount>0&&n._activeTaskCount<n._maxSimultaneousTasks;){var e=n._taskHead;e=Boolean(e)?t(n.detachTask(e)):null}n._isProcessingTasks=!1,n.ensureProcessingTasks()}var n=this;!n._isProcessingTasks&&!n._currentSetTimeoutId&&n._pendingTaskCount&&n._activeTaskCount<n._maxSimultaneousTasks&&(n._currentSetTimeoutId=n._async.setTimeout(i,e.DELAY_BETWEEN_PROCESSING))},e.prototype.completeTask=function(e){e.state===r.Active&&(this._activeTaskCount--,delete this._activeTasks[e.id],this.removeTaskFromQueue(e))},e.prototype.removeTaskFromQueue=function(e){e.state=r.Complete,delete this._tasks[e.id],this.ensureProcessingTasks()},e.DEFAULT_SIMULTANEOUS_TASKS=5,e.DELAY_BETWEEN_PROCESSING=0,e.DEFAULT_QUEUEID="root",e}();return a}),define("odsp-next/dataSources/upload/odb/UploadUrlBuilder",["require","exports","odsp-utilities/encoding/UriEncoding"],function(e,t,r){var i=function(){function e(e){this._queryStrings={},this._pathStrings=[],Boolean(e)?(this._httpRoot=e,this._pathStrings.push(e),"/"!==e[e.length-1]&&this._pathStrings.push("/")):this._pathStrings.push("/"),this._pathStrings.push("_api/web")}return e.prototype.appendPathSegment=function(e){this._pathStrings.push("/"),this._pathStrings.push(e)},e.prototype.appendMethodCall=function(e,t,r){if(Boolean(e)){if(this._pathStrings.push("/"),this._pathStrings.push(e),this._pathStrings.push("("),Boolean(t)){var i=Object.keys(t);if(1===i.length){var n=Boolean(r)?t[i[0]]:this.encodeStringParameter(t[i[0]]);this._pathStrings.push(n)}else for(var a=0;a<i.length;a++){var o=i[a],s=Boolean(r)?t[o]:this.encodeStringParameter(t[o]);a>0&&this._pathStrings.push(","),this._pathStrings.push(o),this._pathStrings.push("="),this._pathStrings.push(s)}}this._pathStrings.push(")")}},e.prototype.appendMethodCallWithParameterAliases=function(e,t){var r=null;if(Boolean(e)){if(Boolean(t)){r={};for(var i=Object.keys(t),n=0;n<i.length;n++){var a=i[n],o=t[a],s="@"+a;r[a]=s,this.addQueryString(s,o)}}this.appendMethodCall(e,r,!0)}},e.prototype.addQueryString=function(e,t){e in this._queryStrings||(this._queryStrings[e]=t)},e.prototype.toGuidParameter=function(e){return"guid'"+e+"'"},e.prototype.isGuidParameter=function(e){if(Boolean(e)){var t=/^guid'[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}'$/i;return t.test(e)}return!1},e.prototype.encodeStringParameter=function(e){var t=e;return Boolean(e)&&(this.isGuidParameter(t)||(t=this.encodeSPRestURIStringToken(t)),t=r.encodeURIComponent(t)),t},e.prototype.encodeSPRestURIStringToken=function(e){if(Boolean(e)){var t=decodeURIComponent(e);return t=t.replace(/'/g,"''"),"'"+t+"'"}return e},e.prototype.buildUrl=function(){var e=[];if(Boolean(this._queryStrings))for(var t=Object.keys(this._queryStrings),r=0;r<t.length;r++){e.push(0===r?"?":"&");var i=t[r],n="$filter"===i?this._queryStrings[i]:this.encodeStringParameter(this._queryStrings[i]);e.push(i),e.push("="),e.push(n)}var a=this._pathStrings.join("")+e.join("");return a},e}();return i}),define("odsp-next/dataSources/upload/UploadState",["require","exports"],function(){var e;return function(e){e[e.queued=0]="queued",e[e.started=1]="started",e[e.completed=2]="completed",e[e.aborted=3]="aborted",e[e.failed=4]="failed"}(e||(e={})),e}),define("odsp-next/dataSources/upload/UploadErrorType",["require","exports"],function(){var e;return function(e){e[e.none=0]="none",e[e.general=1]="general",e[e.downlevelGeneral=2]="downlevelGeneral",e[e.conflict=3]="conflict",e[e.downlevelConflict=4]="downlevelConflict",e[e.invalidName=5]="invalidName",e[e.fileSize=6]="fileSize",e[e.emptyFileOrFolder=7]="emptyFileOrFolder",e[e.overQuota=8]="overQuota",e[e.accessDenied=9]="accessDenied",e[e.lockMismatch=10]="lockMismatch",e[e.downlevelLockMismatch=11]="downlevelLockMismatch",e[e.overQuotaSharedFolder=12]="overQuotaSharedFolder",e[e.folderUploadNotSupported=13]="folderUploadNotSupported"}(e||(e={})),e}),define("odsp-next/dataSources/upload/UploadError",["require","exports","./UploadErrorType"],function(e,t,r){var i=function(){function e(e){this.message=e.message,this.errorType=e.errorType||r.none,this.maxSizeInBytes=e.maxSizeInBytes,this.allowRename=e.allowRename||!1}return e}();return i}),define("odsp-next/utilities/validation/CommonValidation",["require","exports"],function(){var e=function(){function e(){}return e.IndexOfIllegalCharInUrlLeafName=function(t){for(var r,i=t.length,n=-1,a=0;i>a;a++)r=t.charCodeAt(a),"."===t.charAt(a)&&a===i-1?n=a:160>r&&("/"===t.charAt(a)||!e.LegalUrlChars[r])&&(n=a);return n},e.LegalUrlChars=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,!0,!1,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!1,!0,!1,!0,!1,!1,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!1,!0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],e}();return e}),define("odsp-next/dataSources/upload/odb/FileValidator",["require","exports","./FileValidationStatus","../../../utilities/validation/CommonValidation","../../../utilities/features/Features","odsp-shared/utilities/string/StringHelper","./Upload.resx"],function(e,t,r,i,n,a,o){var s=function(){function e(){}return e.validate=function(t){return t.validationStatus=r.pending,-1!==i.IndexOfIllegalCharInUrlLeafName(t.name)?(t.validationStatus=r.invalid,void(t.validationResult=o.strings.illegalFileNameError)):0===t.size?(t.validationStatus=r.invalid,void(t.validationResult=o.strings.emptyFileError)):!n.default.isFeatureEnabled(n.default.ChunkUploadLargeFile)&&!n.default.isFeatureEnabled(n.default.ChunkUploadAllFile)&&t.size>e.MAX_FILESIZE?(t.validationStatus=r.invalid,void(t.validationResult=a.format(o.strings.uploadMaxFileSizeError,Math.floor(e.MAX_FILESIZE/1048576)))):(t.validationStatus=r.valid,void(t.validationResult=""))},e.MAX_FILESIZE=10737418240,e}();return s});var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};define("odsp-next/dataSources/upload/odb/SingleFileUploader",["require","exports","knockout","odsp-utilities/async/Promise","../../../utilities/queue/Queue","odsp-utilities/guid/Guid","odsp-shared/utilities/logging/events/Upload.event","odsp-utilities/logging/events/Qos.event","./UploadUrlBuilder","odsp-utilities/async/Async","../../../utilities/features/Features","../../../dataSources/base/odb/DataSource","odsp-utilities/encoding/UriEncoding","../UploadState","../NameConflictBehavior","../UploadError","../UploadErrorType","./FileValidator","./FileValidationStatus","../../../resources/ProviderResourceKeys","../../../resources/DataSourceResourceKeys","../../../models/item/OneDriveItem","../../../models/item/ItemType","../../../controls/dragAndDrop/DropHelper"],function(e,t,r,i,n,a,o,s,l,u,d,p,h,c,f,_,v,g,m,S,y,U,b,T){var F=function(e){function t(i,n,a,o,s,l,d){e.call(this,l),this._id=t._guidSeed++,this._file=n,this._parentItem=a,this._folderUpload=s,this._aborted=!1,this._executing=!1,this._uploadId=null,this._pendingRestart=!1,this._chunkNumber=0,this._everStarted=!1,this._retryGuid=0,this._dequeueCallback=null,this._async=new u(this),this.totalBytes=r.observable(this._file.size),this.uploadedBytes=r.observable(0),this.fileName=r.observable(this._file.name),this.iconName=r.observable(this._file.iconName),this.state=r.observable(c.queued),this.error=r.observable(null),this.nameConflictBehavior=r.observable(f.none),this.allowRename=!1,this._itemProvider=i.consume(S.item),this._urlDataSource=i.consume(y.url),this.uploadedItem=null,this._uploadMetadata=d,this._resources=i}return __extends(t,e),t.prototype.getDataSourceName=function(){return"SingleFileUploader"},t.prototype.start=function(){var e=this;if(!this.startPromise){var r=t.TASKID_PREFIX+e._id+"_"+e._retryGuid,n=function(i,n){e._everStarted||t._currentCountOfFilesUploading<t.MAX_FILES_TO_UPLOAD?(e._everStarted||t._currentCountOfFilesUploading++,e._everStarted=!0,e._aborted||t._uploadQueue.enqueue(function(t){return e._shouldContinueRequest()?(e._dequeueCallback=t,e._executing=!0,e.error(null),e.state(c.started),e.uploadedBytes(0),e.startUpload().then(i,n),!0):!1},function(){e.abort()},r)):e._file.dispose()},a=function(){t._uploadQueue.abortTask(r)};this.startPromise=new i.default(n,a)}return this.startPromise},t.prototype.startUpload=function(){var e=this;if(e.validateFile(e._file),e._file.validationStatus===m.invalid)return e._handleError(new _({message:e._file.validationResult,errorType:v.none})),i.default.wrapError(e._file.validationResult);var r=function(r,i){e._executing=!0;var n=function(t){e.uploadedItem=t;var i=function(){e._shouldContinueRequest()&&(e.state(c.completed),e._callDequeueCallback(),e._uploadEvent&&(e._uploadEvent.end({resultType:s.ResultTypeEnum.Success}),e._uploadEvent=null),r())};e._uploadMetadata?T.updateMetadata([t],e._uploadMetadata,i,e._resources):i()},l=function(t){if(e._shouldContinueRequest()){var r=e._getUploadErrorFromErrorResponse(t);e._handleError(r),i(r.message)}};if(!e._uploadEvent){for(var u=!1,p=e._parentItem;p;){if(p.isMountPoint){u=!0;break}p=p.parent}e._uploadEvent=new o.Upload({name:"Upload."+e._file.upType,dragAndDrop:e._file.dragDrop,size:e._file.size,extension:e._file.extension.replace(".",""),folderUpload:e._folderUpload,groupFolder:u})}d.default.isFeatureEnabled(d.default.ChunkUploadLargeFile)&&e._file.size>t.LARGE_FILESIZE||d.default.isFeatureEnabled(d.default.ChunkUploadAllFile)?(Boolean(e._uploadId)||(e._uploadId=a.default.generate()),e._startFragmentsUpload().then(n,l)):e._isConflictFile(e._parentItem.id,e._file.name).then(function(t){if(t){var r=new _({message:"",errorType:v.conflict});e._handleError(r)}else{var i=new FileReader;i.onload=function(t){var r=t.target.result;e._uploadFile(e._parentItem.id,e._file.name,r).then(n,l)},i.readAsArrayBuffer(e._file.file)}})},n=function(){e.abort()};return new i.default(r,n)},t.prototype.abort=function(){this._aborted||(this._uploadEvent&&(this._uploadEvent.end({resultType:s.ResultTypeEnum.ExpectedFailure,resultCode:"Aborted"}),this._uploadEvent=null),this._cancelChunkUpload(),this._uploadId=null,this._pendingRestart=!1,this.startPromise&&this.startPromise.cancel(),this._file.dispose(),this._async.dispose(),this.error(null),this.state(c.aborted),this._callDequeueCallback(),this._everStarted&&t._currentCountOfFilesUploading--,this._aborted=!0)},t.prototype.restart=function(){this._executing?(this._pendingRestart=!0,this._cancelChunkUpload()):(this.startPromise=null,this._aborted=!1,this.start())},t.prototype.validateFile=function(e){g.validate(e)},t.prototype.setFileData=function(){},t.prototype._callDequeueCallback=function(){this._dequeueCallback&&(this._executing=!1,this._dequeueCallback(),this._dequeueCallback=null)},t.prototype._handleError=function(e){e&&(this._uploadEvent&&(this._uploadEvent.end({resultType:s.ResultTypeEnum.Failure,resultCode:v[e.errorType]}),this._uploadEvent=null),this.error(e),this.state(c.failed),this._callDequeueCallback())},t.prototype._getUploadErrorFromErrorResponse=function(e){var r,i,n,a=this._getUploaErrorCodeFromErrorResponse(e);return n=e.message&&e.message.value?e.message.value:e,r=a===t.ERRORCODE_DOCALREADYEXISTS?v.conflict:v.none,i=new _({message:n,errorType:r,allowRename:this.allowRename})},t.prototype._getUploaErrorCodeFromErrorResponse=function(e){var t,r;return e.code&&(t=e.code.split(","),r=t.length>0?Number(t[0]):null),r},t.prototype._getUploadFileUrl=function(e,t){var r=[],i=this._parentItem.properties?this._parentItem.properties.UniqueId:null;r.push(h.escapeUrlForCallback(this._context.webUrl)),r.push("/");var n="";return i?(r.push("_api/web/getfolderbyid(@fileUrl"),n=i):(r.push("_api/web/GetFolderByServerRelativeUrl(@fileUrl"),n=h.encodeRestUriStringToken(e)),r.push(")/Files/Add(url=@url"),r.push(this.nameConflictBehavior()===f.overwrite?",overwrite=true)":")"),r.push("?"),this._uploadMetadata&&this._uploadMetadata.group&&r.push("$Expand=ListItemAllFields&"),r.push("@fileUrl='"),r.push(n),r.push("'&@url='"),r.push(h.encodeRestUriStringToken(t)),r.push("'"),r.join("")},t.prototype._isConflictFile=function(e,t){if(this.nameConflictBehavior()===f.overwrite)return i.default.wrap(!1);var r=new l(this._context.webUrl),n={folder:h.encodeRestUriStringToken(e)},a="Name eq '"+h.encodeRestUriStringToken(t)+"'";r.appendMethodCall("GetFolderByServerRelativeUrl",n),r.appendPathSegment("Files"),r.addQueryString("$filter",a);var o=this.getData(function(){return r.buildUrl()},function(e){var t=JSON.parse(e);return t&&t.d&&t.d.results&&t.d.results.length>0?!0:!1},"GetFile");return o.then(function(e){return e},function(){return!1})},t.prototype._uploadFile=function(e,t,r){var i=this;return this.getData(function(){return i._getUploadFileUrl(e,t)},function(e){i.setFileData(e);var t=JSON.parse(e);t=t.d;var r=new U;return r.type=b.File,r.id=t.ServerRelativeUrl,r.key=i._urlDataSource.getKey(t),r.name=t.Name,r.properties=t.ListItemAllFields?{ID:t.ListItemAllFields.Id}:null,r},"UploadFile",function(){return r})},t.prototype._generateChunkPostUrl=function(e,t){var r=this._file,i=this._parentItem.properties?this._parentItem.properties.UniqueId:null,n=new l(this._context.webUrl),a="",o={folder:h.encodeRestUriStringToken(this._parentItem.id)},s={uniqueId:i},u={file:h.encodeRestUriStringToken(r.name)},d={file:h.encodeRestUriStringToken(this._parentItem.id+"/"+r.name)},p={},c=n.toGuidParameter(this._uploadId),_=r.size<=t;return 0===this._chunkNumber?(this._uploadMethod="StartUpload",i?n.appendMethodCallWithParameterAliases("getfolderbyid",s):n.appendMethodCallWithParameterAliases("getFolderByServerRelativeUrl",o),n.appendPathSegment("files"),this.nameConflictBehavior()===f.overwrite?n.appendMethodCallWithParameterAliases("getByUrlOrAddStub",u):n.appendMethodCallWithParameterAliases("addStub",u),p={uploadId:c}):(this._uploadMethod=_?"FinishUpload":"ContinueUpload",i?(n.appendMethodCallWithParameterAliases("getfolderbyid",s),n.appendPathSegment("files"),n.appendMethodCallWithParameterAliases("getByUrl",u)):n.appendMethodCallWithParameterAliases("getFileByServerRelativeUrl",d),p={uploadId:c,fileOffset:e}),n.appendMethodCall(this._uploadMethod,p),a=n.buildUrl()},t.prototype._sendFileRequest=function(e,t){var r=this;return r.getData(function(){return r._generateChunkPostUrl(e,t)},function(e){return r.setFileData(e),e},"SendFileRequest",function(){return r._file.getBlob(e,t)})},t.prototype._uploadFragment=function(e,r,n){var a=this,o=this._file.size,s=function(i,s){a._sendFileRequest(e,r).done(function(){a.uploadedBytes(r),a._shouldContinueRequest()&&(o>r?(a._chunkNumber++,e=r,r=Math.min(e+t.UPLOAD_CHUNK_SIZE,o),a._uploadFragment(e,r,t.MAX_RETRY_COUNT).done(i,s)):i())},function(o){a._shouldContinueRequest()&&(n-->0&&a._canRetry(o)?a._async.setTimeout(function(){a._uploadFragment(e,r,n).done(i,s)},t.RETRY_INTERVAL):s(o))})};return new i.default(s,null)},t.prototype._startFragmentsUpload=function(){var e=0,r=Math.min(e+t.UPLOAD_CHUNK_SIZE,this._file.size);return this._uploadFragment(e,r,t.MAX_RETRY_COUNT)},t.prototype._canRetry=function(e){var r=this._getUploaErrorCodeFromErrorResponse(e),i=!0;return r===t.ERRORCODE_DOCALREADYEXISTS&&(i=!1),i},t.prototype._cancelChunkUpload=function(){if(this._uploadId){this._uploadMethod="CancelUpload";var e=new l(this._context.webUrl),t=this._file,r={file:this._parentItem.id+"/"+t.name},n=e.toGuidParameter(this._uploadId),a={uploadId:n},o="";return e.appendMethodCallWithParameterAliases("getFileByServerRelativeUrl",r),e.appendMethodCall(this._uploadMethod,a),o=e.buildUrl(),this.getData(function(){return o},function(e){return e},"CancelUploadSession")}return i.default.wrap("")},t.prototype._hasPendingRestart=function(){return this._pendingRestart?(this._callDequeueCallback(),this._pendingRestart=!1,this.restart(),!0):!1},t.prototype._shouldContinueRequest=function(){return!this._aborted&&!this._hasPendingRestart()},t.MEGABYTES=1048576,t.UPLOAD_CHUNK_SIZE=8*t.MEGABYTES,t.LARGE_FILESIZE=30*t.MEGABYTES,t.MAX_CURRENT_UPLOADS=3,t.MAX_FILES_TO_UPLOAD=1e3,t.MAX_RETRY_COUNT=3,t.RETRY_INTERVAL=1e3,t.TASKID_PREFIX="uploadqueue_",t.ERRORCODE_DOCALREADYEXISTS=-2130575257,t.throttler=new u,t._uploadQueue=new n(t.MAX_CURRENT_UPLOADS,"upload"),t._currentCountOfFilesUploading=0,t._guidSeed=0,t}(p);return F});var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};define("odsp-next/dataSources/upload/odb/FileUploadManager",["require","exports","../BaseBatchUploader","./Html5FileUpload","odsp-utilities/async/Promise","./SingleFileUploader","../../../resources/SPOResourceKeys"],function(e,t,r,i,n,a,o){var s=function(e){function t(t){if(e.call(this,t),t.files)for(var r=t.files,n=0,s=r[n];s;){var l=new i(s,t.wasDragAndDropped),u=new a(this.resources,l,t.parentItem,this.batchStartTime,null,t.resources.consume(o.hostSettings),t.metadata);this.filesUploading.push(u),n++,s=r[n]}}return __extends(t,e),t.prototype.start=function(){for(var e=this.filesUploading(),t=0;t<e.length;t++)e[t].start();return n.default.wrap()},t}(r);return s}),define("odsp-next/dataSources/upload/FileItem",["require","exports"],function(){var e=function(){function e(e){if(e){this.file=e,this.name=e.name,this.relativePath="";var t=e.webkitRelativePath;this._hasWebKitPath=!1,t&&(this.relativePath=t,this._hasWebKitPath=!0)}}return e.prototype.addParentPath=function(e){this._hasWebKitPath||(this.relativePath=this.relativePath&&e.relativePath?e.relativePath+"/"+this.relativePath:e.relativePath?e.relativePath+"/"+this.name:this.name)},e}();return e});var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};define("odsp-next/dataSources/upload/SingleFolderUploader",["require","exports","odsp-shared/base/BaseModel","./UploadState","./NameConflictBehavior","./UploadError","../../resources/DataSourceResourceKeys","knockout"],function(e,t,r,i,n,a,o,s){var l=function(e){function t(t){e.call(this,t),this._itemDataSource=this.resources.consume(o.items),this._parent=t.parent,this._item=t.item,this.state=s.observable(i.queued),this.uploadedBytes=s.observable(0),this.totalBytes=s.observable(0),this.fileName=s.observable(t.name),this.iconName=s.observable("folder"),this.error=s.observable(),this.nameConflictBehavior=s.observable(n.none),this.allowRename=!1,this.isDownlevel=!1}return __extends(t,e),t.prototype.start=function(){var e=this;this._itemDataSource.createFolder({parent:this._parent,folderName:this.fileName.peek()}).then(function(t){e._item(t),e.state(i.completed)},function(t){e.error(new a({message:t})),e.state(i.failed)}),this.state(i.started)},t.prototype.abort=function(){this.state(i.aborted)},t.prototype.restart=function(){},t}(r);Object.defineProperty(t,"__esModule",{value:!0}),t.default=l});var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};define("odsp-next/dataSources/upload/BaseFolderUploadManager",["require","exports","./BaseBatchUploader","odsp-utilities/async/Promise","./FileItem","./SingleFolderUploader","knockout"],function(e,t,r,i,n,a,o){var s=function(e){function t(t){e.call(this,t),this._createdFolders=o.observable({"":t.parentItem}),this._dirsToCreate=[],this._batchStartTime=Date.now(),this._wasDragAndDropped=t.wasDragAndDropped,this._fileList=t.files,this._uploaders={},this._paths={},this._uploadMetadata=t.metadata}return __extends(t,e),t.prototype.start=function(){var e=this,t=this._fileList;return t?this._loadFiles(t).then(function(t){t.forEach(function(t){e._addFilePath(t.relativePath)}),e._createDirectories(),e._uploadFiles(t)}):i.default.wrap()},t.prototype.createSingleFileUploader=function(){throw Error("Not Implemented")},t.prototype._uploadFiles=function(e){var t=this;e.forEach(function(e){var r=e.relativePath.substring(0,e.relativePath.lastIndexOf("/")),i=t.createComputed(function(){var n=t._createdFolders();if(n[r]&&!t._uploaders[e.relativePath]){var a=n[r],o=t.createSingleFileUploader(e.file,a,t._uploadMetadata);t.filesUploading.push(o),o.start(),t._uploaders[e.relativePath]=o,i&&i.dispose()}})})},t.prototype._loadFiles=function(e){for(var t=[],r=function(e){return new i.default(function(t,r){e.file(function(e){return t(new n(e))},r)})},a=0;a<e.length;a++){var o=e[a],s=void 0;if(o){if(o.isFile||o.isDirectory)s=o;else if(o.getAsEntry)s=o.getAsEntry();else if(o.webkitGetAsEntry)s=o.webkitGetAsEntry();else{if("function"==typeof o.getAsFile){t.push(new n(o.getAsFile()));continue}if(File&&o instanceof File){t.push(new n(o));continue}}s&&s.isFile?t.push(r(s)):s&&s.isDirectory&&t.push(this._loadDirectory(s))}}return i.default.all(t).then(function(e){var t=new n;t.children=e;for(var r=[t],i=[],a=function(e){return function(t){t.addParentPath(e),t.children?r.push(t):i.push(t)}};r.length;){var o=r.shift();o.children.forEach(a(o))}return i})},t.prototype._loadDirectory=function(e){var t=this,r=e.createReader();return new i.default(function(i,a){var o=[],s=function(){r.readEntries(function(r){r.length?(o=o.concat(Array.prototype.slice.call(r,0)),s()):t._loadFiles(o).done(function(t){var r=new n;r.name=e.name,r.children=t,i(r)},a)},a)};s()})},t.prototype._addFilePath=function(e){var t=this._paths,r=e.split("/");if(r.length>1)for(var i="",n=0,a=r.slice(0,-1);n<a.length;n++){var o=a[n];i&&(i+="/"),i+=o,t[i]||(this._dirsToCreate.push(i),t[i]=!0)}},t.prototype._createDirectories=function(){var e=this;this._dirsToCreate.forEach(function(t){var r=t.lastIndexOf("/"),i=t.substring(r+1),n=t.substring(0,r),s=o.observable();e.createComputed(function(){if(s()){var r=e._createdFolders.peek();r[t]=s(),e._createdFolders.valueHasMutated()}});var l=e.createComputed(function(){var r=e._createdFolders(),o=e._uploaders;if(r[n]&&!r[t]&&!o[t]){var u=new(e.managed(a.default))({parent:r[n],name:i,item:s});e.filesUploading.push(u),o[t]=u,u.start(),l&&l.dispose()}})})},t}(r);return s});var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};define("odsp-next/dataSources/upload/odb/FolderUploadManager",["require","exports","./SingleFileUploader","./Html5FileUpload","../BaseFolderUploadManager","../../../resources/SPOResourceKeys"],function(e,t,r,i,n,a){var o=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype.createSingleFileUploader=function(e,t,n){var o=new(this.managed(i))(e,this._wasDragAndDropped);return new r(this.resources,o,t,this._batchStartTime,!0,this.resources.consume(a.hostSettings),n)},t}(n);return o}),define("odsp-next/dataSources/upload/odb/UploadManager",["require","exports","./FileUploadManager","./FolderUploadManager","../UploadProcessorType","odsp-utilities/async/Promise"],function(e,t,r,i,n,a){var o=function(){function e(){}return e.upload=function(e){return e.type===n.Html5file?a.default.wrap(new r(e)):e.type===n.Folder?a.default.wrap(new i(e)):a.default.wrapError(Error("Unsupported upload processor type"))},e}();return o});